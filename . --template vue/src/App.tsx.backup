import { useState, useEffect } from 'react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import jsPDF from 'jspdf'
import 'jspdf-autotable'
import Admin from '@/components/Admin'
import { calculateQuotation, formatCurrency } from '@/utils/calculator'

interface Product {
  name: string
  density: string // 升位系数
  vat_rate: number // 税率
  refund_rate: number // 退税率
  price_per_ton: number // 吨价
  origin: string // 起始地
}

function Quoter() {
  const [products, setProducts] = useState<Product[]>([])
  const [searchQuery, setSearchQuery] = useState('')
  const [selectedProduct, setSelectedProduct] = useState<Product | null>(null)

  // 报价参数
  const [bagWeight, setBagWeight] = useState(0) // 每袋重量
  const [totalBags, setTotalBags] = useState(0) // 袋数
  const [packagingPrice, setPackagingPrice] = useState(0) // 包装单价
  const [totalShipping, setTotalShipping] = useState(0) // 总运费
  const [exchangeRate, setExchangeRate] = useState(7.2) // 汇率
  const [profitRate, setProfitRate] = useState(1.1) // 利润率

  const filteredProducts = products.filter(product =>
    product.name.toLowerCase().includes(searchQuery.toLowerCase())
  )

  // 计算报价结果
  const calculationResult = selectedProduct && bagWeight && totalBags && exchangeRate && profitRate
    ? calculateQuotation(selectedProduct, bagWeight, totalBags, packagingPrice, totalShipping, exchangeRate, profitRate)
    : null

  useEffect(() => {
    // @ts-ignore
    window.ipcRenderer.on('product-data', (event, data) => {
      setProducts(data)
    })
  }, [])

  const selectProduct = (product: Product) => {
    setSelectedProduct(product)
    setSearchQuery(product.name)
  }

  const exportPDF = async () => {
    if (!calculationResult) return

    // @ts-ignore
    const template = await window.ipcRenderer.invoke('get-sheet1-template')

    const doc = new jsPDF()
    doc.text('Product Quotation', 20, 20)

    // Add product details
    doc.text(`Product: ${calculationResult.productName}`, 20, 40)
    doc.text(`Origin: ${selectedProduct?.origin}`, 20, 50)
    doc.text(`Bag Weight: ${calculationResult.bagWeight} KG`, 20, 60)
    doc.text(`Total Bags: ${calculationResult.totalBags}`, 20, 70)
    doc.text(`Packaging Price: ${formatCurrency(calculationResult.packagingPrice)}`, 20, 80)
    doc.text(`Total Shipping: ${formatCurrency(calculationResult.totalShipping)}`, 20, 90)
    doc.text(`Exchange Rate: ${calculationResult.exchangeRate}`, 20, 100)
    doc.text(`Profit Rate: ${(calculationResult.profitRate * 100).toFixed(1)}%`, 20, 110)

    // Add calculation results
    doc.text('Calculation Results:', 20, 130)
    doc.text(`Purchase Price per Bag: ${formatCurrency(calculationResult.purchasePricePerBag)}`, 20, 140)
    doc.text(`USD Quote per Bag: ${formatCurrency(calculationResult.usdQuotePerBag, 'USD')}`, 20, 150)
    doc.text(`Exchange Cost per Bag: ${formatCurrency(calculationResult.exchangeCostPerBag, 'USD')}`, 20, 160)
    doc.text(`Total Purchase Cost: ${formatCurrency(calculationResult.totalPurchaseCost)}`, 20, 170)
    doc.text(`Total USD Quote: ${formatCurrency(calculationResult.totalUsdQuote, 'USD')}`, 20, 180)
    doc.text(`Total Profit: ${formatCurrency(calculationResult.totalProfit, 'USD')}`, 20, 190)

    // Add template table if available
    if (template && template.length > 0) {
      // @ts-ignore
      doc.autoTable({
        head: [template[0]],
        body: template.slice(1),
        startY: 210
      })
    }

    doc.save('quotation.pdf')
  }

  return (
    <div className="space-y-6">
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* 左侧：产品选择和参数输入 */}
        <div className="space-y-6">
          <Card className="border-zinc-800 bg-zinc-950 rounded-md">
            <CardHeader>
              <CardTitle className="text-xl">Product Selection</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div>
                <label htmlFor="search" className="block text-sm font-medium mb-2">
                  Search Product:
                </label>
                <Input
                  id="search"
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  placeholder="Enter product name"
                  className="bg-zinc-900 border-zinc-800 text-white placeholder:text-zinc-400"
                />
                {filteredProducts.length > 0 && (
                  <div className="mt-2 border border-zinc-800 rounded-md max-h-40 overflow-y-auto bg-zinc-900">
                    {filteredProducts.map((product, index) => (
                      <div
                        key={index}
                        className="p-2 hover:bg-zinc-800 cursor-pointer border-b border-zinc-800 last:border-b-0 text-white"
                        onClick={() => selectProduct(product)}
                      >
                        {product.name} - {formatCurrency(product.price_per_ton)}/ton - {product.origin}
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {selectedProduct && (
                <Card className="border-zinc-800 bg-zinc-900 rounded-md">
                  <CardHeader>
                    <CardTitle className="text-lg">Selected Product</CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-2">
                    <p><strong>Name:</strong> {selectedProduct.name}</p>
                    <p><strong>Price per Ton:</strong> {formatCurrency(selectedProduct.price_per_ton)}</p>
                    <p><strong>VAT Rate:</strong> {(selectedProduct.vat_rate * 100).toFixed(1)}%</p>
                    <p><strong>Refund Rate:</strong> {(selectedProduct.refund_rate * 100).toFixed(1)}%</p>
                    <p><strong>Origin:</strong> {selectedProduct.origin}</p>
                    <p><strong>Density:</strong> {selectedProduct.density}</p>
                  </CardContent>
                </Card>
              )}
            </CardContent>
          </Card>

          <Card className="border-zinc-800 bg-zinc-950 rounded-md">
            <CardHeader>
              <CardTitle className="text-xl">Quotation Parameters</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label htmlFor="bagWeight" className="block text-sm font-medium mb-2">
                    Bag Weight (KG/L):
                  </label>
                  <Input
                    id="bagWeight"
                    type="number"
                    value={bagWeight}
                    onChange={(e) => setBagWeight(Number(e.target.value))}
                    min="0"
                    step="0.01"
                    className="bg-zinc-900 border-zinc-800 text-white"
                  />
                </div>
                <div>
                  <label htmlFor="totalBags" className="block text-sm font-medium mb-2">
                    Total Bags:
                  </label>
                  <Input
                    id="totalBags"
                    type="number"
                    value={totalBags}
                    onChange={(e) => setTotalBags(Number(e.target.value))}
                    min="0"
                    className="bg-zinc-900 border-zinc-800 text-white"
                  />
                </div>
                <div>
                  <label htmlFor="packagingPrice" className="block text-sm font-medium mb-2">
                    Packaging Price (¥):
                  </label>
                  <Input
                    id="packagingPrice"
                    type="number"
                    value={packagingPrice}
                    onChange={(e) => setPackagingPrice(Number(e.target.value))}
                    min="0"
                    step="0.01"
                    className="bg-zinc-900 border-zinc-800 text-white"
                  />
                </div>
                <div>
                  <label htmlFor="totalShipping" className="block text-sm font-medium mb-2">
                    Total Shipping (¥):
                  </label>
                  <Input
                    id="totalShipping"
                    type="number"
                    value={totalShipping}
                    onChange={(e) => setTotalShipping(Number(e.target.value))}
                    min="0"
                    step="0.01"
                    className="bg-zinc-900 border-zinc-800 text-white"
                  />
                </div>
                <div>
                  <label htmlFor="exchangeRate" className="block text-sm font-medium mb-2">
                    Exchange Rate:
                  </label>
                  <Input
                    id="exchangeRate"
                    type="number"
                    value={exchangeRate}
                    onChange={(e) => setExchangeRate(Number(e.target.value))}
                    min="0"
                    step="0.01"
                    className="bg-zinc-900 border-zinc-800 text-white"
                  />
                </div>
                <div>
                  <label htmlFor="profitRate" className="block text-sm font-medium mb-2">
                    Profit Rate (multiplier):
                  </label>
                  <Input
                    id="profitRate"
                    type="number"
                    value={profitRate}
                    onChange={(e) => setProfitRate(Number(e.target.value))}
                    min="1"
                    step="0.01"
                    className="bg-zinc-900 border-zinc-800 text-white"
                  />
                </div>
              </div>
            </CardContent>
          </Card>
        </div>

        {/* 右侧：计算结果显示 */}
        <div className="space-y-6">
          <Card className="border-zinc-800 bg-zinc-950 rounded-md">
            <CardHeader>
              <CardTitle className="text-xl">Calculation Results</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              {calculationResult ? (
                <div className="space-y-4">
                  <div className="grid grid-cols-2 gap-4">
                    <div className="p-4 border border-zinc-800 rounded-md bg-zinc-900">
                      <p className="text-sm text-zinc-400">Purchase Price per Bag</p>
                      <p className="text-lg font-semibold text-green-400">
                        {formatCurrency(calculationResult.purchasePricePerBag)}
                      </p>
                    </div>
                    <div className="p-4 border border-zinc-800 rounded-md bg-zinc-900">
                      <p className="text-sm text-zinc-400">USD Quote per Bag</p>
                      <p className="text-lg font-semibold text-blue-400">
                        {formatCurrency(calculationResult.usdQuotePerBag, 'USD')}
                      </p>
                    </div>
                    <div className="p-4 border border-zinc-800 rounded-md bg-zinc-900">
                      <p className="text-sm text-zinc-400">Exchange Cost per Bag</p>
                      <p className="text-lg font-semibold text-yellow-400">
                        {formatCurrency(calculationResult.exchangeCostPerBag, 'USD')}
                      </p>
                    </div>
                    <div className="p-4 border border-zinc-800 rounded-md bg-zinc-900">
                      <p className="text-sm text-zinc-400">Total Profit</p>
                      <p className="text-lg font-semibold text-purple-400">
                        {formatCurrency(calculationResult.totalProfit, 'USD')}
                      </p>
                    </div>
                  </div>

                  <div className="p-4 border border-zinc-800 rounded-md bg-zinc-900">
                    <p className="text-sm text-zinc-400">Total USD Quote</p>
                    <p className="text-2xl font-bold text-green-400">
                      {formatCurrency(calculationResult.totalUsdQuote, 'USD')}
                    </p>
                  </div>
                </div>
              ) : (
                <div className="text-center text-zinc-400 py-8">
                  Please select a product and fill in all parameters to see calculation results.
                </div>
              )}
            </CardContent>
          </Card>

          <Button
            onClick={exportPDF}
            disabled={!calculationResult}
            className="w-full bg-zinc-800 hover:bg-zinc-700 text-white disabled:bg-zinc-600 disabled:text-zinc-400"
          >
            Export PDF
          </Button>
        </div>
      </div>
    </div>
  )
}
    doc.text(`Elevation Factor: ${selectedProduct.elevationFactor}`, 20, 50)
    doc.text(`Tax Rate: ${selectedProduct.taxRate}`, 20, 60)
    doc.text(`Cost Price: ${selectedProduct.costPrice}`, 20, 70)
    doc.text(`Factory Address: ${selectedProduct.factoryAddress}`, 20, 80)
    doc.text(`Quantity: ${quantity}`, 20, 90)
    doc.text(`Total: ${total}`, 20, 100)

    // Add template table if available
    if (template && template.length > 0) {
      // @ts-ignore
      doc.autoTable({
        head: [template[0]],
        body: template.slice(1),
        startY: 110
      })
    }

    doc.save('quotation.pdf')
  }

  return (
    <div className="space-y-6">
      <Card className="border-zinc-800 bg-zinc-950 rounded-md">
        <CardHeader>
          <CardTitle className="text-xl">Product Quotation System</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <label htmlFor="search" className="block text-sm font-medium mb-2">
              Search Product:
            </label>
            <Input
              id="search"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              placeholder="Enter product name"
              className="bg-zinc-900 border-zinc-800 text-white placeholder:text-zinc-400"
            />
            {filteredProducts.length > 0 && (
              <div className="mt-2 border border-zinc-800 rounded-md max-h-40 overflow-y-auto bg-zinc-900">
                {filteredProducts.map((product, index) => (
                  <div
                    key={index}
                    className="p-2 hover:bg-zinc-800 cursor-pointer border-b border-zinc-800 last:border-b-0 text-white"
                    onClick={() => selectProduct(product)}
                  >
                    {product.name} - Cost: ${product.costPrice} - Tax: {product.taxRate} - Address: {product.factoryAddress}
                  </div>
                ))}
              </div>
            )}
          </div>

          {selectedProduct && (
            <Card className="border-zinc-800 bg-zinc-900 rounded-md">
              <CardHeader>
                <CardTitle className="text-lg">Selected Product</CardTitle>
              </CardHeader>
              <CardContent className="space-y-2">
                <p><strong>Name:</strong> {selectedProduct.name}</p>
                <p><strong>Elevation Factor:</strong> {selectedProduct.elevationFactor}</p>
                <p><strong>Tax Rate:</strong> {selectedProduct.taxRate}</p>
                <p><strong>Cost Price:</strong> ${selectedProduct.costPrice}</p>
                <p><strong>Factory Address:</strong> {selectedProduct.factoryAddress}</p>
              </CardContent>
            </Card>
          )}

          <div>
            <label htmlFor="quantity" className="block text-sm font-medium mb-2">
              Quantity (Bags):
            </label>
            <Input
              id="quantity"
              type="number"
              value={quantity}
              onChange={(e) => setQuantity(Number(e.target.value))}
              min="0"
              className="bg-zinc-900 border-zinc-800 text-white"
            />
          </div>

          {total > 0 && (
            <div className="p-4 border border-zinc-800 rounded-md bg-zinc-900">
              <p className="text-lg font-semibold text-green-400">
                Total: ${total.toFixed(2)}
              </p>
            </div>
          )}

          <Button
            onClick={exportPDF}
            disabled={!selectedProduct || !quantity}
            className="w-full bg-zinc-800 hover:bg-zinc-700 text-white disabled:bg-zinc-600 disabled:text-zinc-400"
          >
            Export PDF
          </Button>
        </CardContent>
      </Card>
    </div>
  )
}

function App() {
  return (
    <div className="min-h-screen bg-zinc-950 text-white p-6">
      <div className="max-w-6xl mx-auto">
        <Tabs defaultValue="quoter" className="w-full">
          <TabsList className="grid w-full grid-cols-2 bg-zinc-900 border-zinc-800">
            <TabsTrigger value="quoter" className="data-[state=active]:bg-zinc-800 data-[state=active]:text-white text-zinc-300">
              Quoter
            </TabsTrigger>
            <TabsTrigger value="admin" className="data-[state=active]:bg-zinc-800 data-[state=active]:text-white text-zinc-300">
              Admin
            </TabsTrigger>
          </TabsList>
          <TabsContent value="quoter" className="mt-6">
            <Quoter />
          </TabsContent>
          <TabsContent value="admin" className="mt-6">
            <Admin />
          </TabsContent>
        </Tabs>
      </div>
    </div>
  )
}

export default App
