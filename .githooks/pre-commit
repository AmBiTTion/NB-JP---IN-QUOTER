#!/bin/sh

files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|json|css|md)$')
[ -z "$files" ] && exit 0

bad=0

while IFS= read -r f; do
  [ -z "$f" ] && continue
  if git show -- ":$f" | python -c "import sys; sys.exit(1 if b'\0' in sys.stdin.buffer.read() else 0)"; then
    :
  else
    echo "âœ— $f looks like UTF-16/binary (contains NUL). Please convert to UTF-8 (no BOM)."
    bad=1
  fi
done <<EOF
$files
EOF

if [ $bad -eq 1 ]; then
  echo "Commit blocked due to invalid encoding."
  exit 1
fi

exit 0
